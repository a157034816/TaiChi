<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:controls="clr-namespace:TaiChi.Wpf.NodeEditor.Controls"
                    xmlns:selectors="clr-namespace:TaiChi.Wpf.NodeEditor.Controls.Selectors">
    
    <!-- 引入颜色和尺寸资源 -->
    <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="/TaiChi.Wpf.NodeEditor.Controls;component/Themes/Converter.xaml" />
        <ResourceDictionary Source="/TaiChi.Wpf.NodeEditor.Controls;component/Themes/Colors.xaml" />
        <ResourceDictionary Source="/TaiChi.Wpf.NodeEditor.Controls;component/Themes/Dimensions.xaml" />
        <ResourceDictionary Source="./Templates/PinConnectorTemplates.xaml" />
        <ResourceDictionary Source="./Templates/PinInputValueTemplates.xaml" />
    </ResourceDictionary.MergedDictionaries>

    <!-- 默认的输入值模板选择器（可被外部覆盖） -->
    <selectors:DefaultPinInputValueTemplateSelector x:Key="DefaultPinInputValueTemplateSelector"
                                                   DefaultTemplate="{StaticResource DefaultPinInputValueTemplate}"
                                                   StringTemplate="{StaticResource DefaultPinStringInputTemplate}"
                                                   IntTemplate="{StaticResource DefaultPinIntInputTemplate}"
                                                   LongTemplate="{StaticResource DefaultPinLongInputTemplate}"
                                                   FloatTemplate="{StaticResource DefaultPinFloatInputTemplate}"
                                                   DoubleTemplate="{StaticResource DefaultPinDoubleInputTemplate}"
                                                   DecimalTemplate="{StaticResource DefaultPinDecimalInputTemplate}"
                                                   BoolTemplate="{StaticResource DefaultPinBoolInputTemplate}"
                                                   DateTimeTemplate="{StaticResource DefaultPinDateTimeInputTemplate}"
                                                   EnumTemplate="{StaticResource DefaultPinEnumInputTemplate}" />

    <!-- 修正后的 PinControl 样式 -->
    <Style x:Key="{x:Static controls:PinControl.PinStyleKey}" TargetType="{x:Type controls:PinControl}">
        <Setter Property="Margin" Value="{StaticResource PinControl_Margin}" />
        <Setter Property="MinWidth" Value="{StaticResource PinControl_MinWidth}" />
        <Setter Property="MinHeight" Value="{StaticResource PinControl_MinHeight}" />
        <Setter Property="Foreground" Value="{StaticResource PinControl_Foreground}" />
        <Setter Property="Background" Value="{StaticResource PinControl_PinBackground}" />
        <Setter Property="BorderBrush" Value="{StaticResource PinControl_PinBorder}" />
        <Setter Property="BorderThickness" Value="{StaticResource PinControl_BorderThickness}" />
        <Setter Property="StrokeColor" Value="Gray" />
        <Setter Property="StrokeThickness" Value="1" />
        <Setter Property="MainColor" Value="Gray" />
        <Setter Property="Padding" Value="{StaticResource PinControl_ContainerMargin}" />
        <Setter Property="Focusable" Value="True" />
        <Setter Property="SnapsToDevicePixels" Value="True" />
        
        <!-- Default Templates -->
        <Setter Property="PinInputConnectorTemplate" Value="{StaticResource DefaultPinConnectorTemplate}" />
        <Setter Property="PinOutputConnectorTemplate" Value="{StaticResource DefaultPinConnectorTemplate}" />
        <!-- 输入值模板选择器（未连接时生效） -->
        <Setter Property="PinInputValueTemplateSelector" Value="{StaticResource DefaultPinInputValueTemplateSelector}" />
        
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:PinControl}">
                    <Grid>
                        <!-- 输入引脚布局 -->
                        <Grid x:Name="InputPinLayout"
                              Visibility="{Binding PinData.Direction,
                                         RelativeSource={RelativeSource TemplatedParent},
                                         Converter={StaticResource EnumToVisibilityConverter},
                                         ConverterParameter=Input}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- 连接器 -->
                            <ContentControl x:Name="PART_InputConnector"
                                          Grid.Column="0"
                                          Content="{Binding}"
                                          ContentTemplate="{Binding PinInputConnectorTemplate, RelativeSource={RelativeSource TemplatedParent}}"
                                          ContentTemplateSelector="{Binding PinInputConnectorTemplateSelector, RelativeSource={RelativeSource TemplatedParent}}"
                                          Tag="{Binding RelativeSource={RelativeSource TemplatedParent}}" />

                            <!-- 未连接时的输入控件（根据 DataType 选择模板） -->
                            <ContentControl x:Name="PART_InputValue"
                                            Grid.Column="2"
                                            Content="{Binding PinData, RelativeSource={RelativeSource TemplatedParent}}"
                                            ContentTemplate="{Binding PinInputValueTemplate, RelativeSource={RelativeSource TemplatedParent}}"
                                            ContentTemplateSelector="{Binding PinInputValueTemplateSelector, RelativeSource={RelativeSource TemplatedParent}}"
                                            Margin="{StaticResource PinControl_ContentMargin}">
                                <ContentControl.Visibility>
                                    <MultiBinding Converter="{StaticResource PinInputValueVisibilityConverter}">
                                        <Binding Path="PinData.IsFlowPin" RelativeSource="{RelativeSource TemplatedParent}" />
                                        <Binding Path="PinData.Connection" RelativeSource="{RelativeSource TemplatedParent}" />
                                    </MultiBinding>
                                </ContentControl.Visibility>
                            </ContentControl>

                            <!-- 标签 -->
                            <TextBlock x:Name="PART_InputLabel" Grid.Column="1"
                                       Text="{Binding PinData.Name, RelativeSource={RelativeSource TemplatedParent}}"
                                       VerticalAlignment="Center"
                                       FontSize="{StaticResource PinControl_FontSize_Normal}"
                                       Foreground="{StaticResource PinControl_Foreground}"
                                       Margin="{StaticResource PinControl_ContentMargin}" />
                        </Grid>

                        <!-- 输出引脚布局 -->
                        <Grid x:Name="OutputPinLayout"
                              Visibility="{Binding PinData.Direction,
                                         RelativeSource={RelativeSource TemplatedParent},
                                         Converter={StaticResource EnumToVisibilityConverter},
                                         ConverterParameter=Output}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- 标签 -->
                            <TextBlock Grid.Column="0"
                                       Text="{Binding PinData.Name, RelativeSource={RelativeSource TemplatedParent}}"
                                       VerticalAlignment="Center"
                                       FontSize="{StaticResource PinControl_FontSize_Normal}"
                                       Foreground="{StaticResource PinControl_Foreground}"
                                       HorizontalAlignment="Right"
                                       Margin="{StaticResource PinControl_OutputContentMargin}" />

                            <!-- 连接器 -->
                            <ContentControl x:Name="PART_OutputConnector"
                                          Grid.Column="1"
                                          Content="{Binding}"
                                          ContentTemplate="{Binding PinOutputConnectorTemplate, RelativeSource={RelativeSource TemplatedParent}}"
                                          ContentTemplateSelector="{Binding PinOutputConnectorTemplateSelector, RelativeSource={RelativeSource TemplatedParent}}"
                                          Tag="{Binding RelativeSource={RelativeSource TemplatedParent}}" />
                        </Grid>
                    </Grid>

                    <ControlTemplate.Triggers>
                        <!-- 高亮状态 -->
                        <Trigger Property="IsHighlighted" Value="True">
                            <Setter TargetName="PART_InputConnector" Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect Color="{StaticResource PinControl_HighlightColor}" 
                                                     BlurRadius="{StaticResource PinControl_ShadowBlurRadius}" 
                                                     ShadowDepth="{StaticResource PinControl_ShadowDepth}" 
                                                     Opacity="{StaticResource PinControl_EffectOpacity}" />
                                </Setter.Value>
                            </Setter>
                            <Setter TargetName="PART_OutputConnector" Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect Color="{StaticResource PinControl_HighlightColor}" 
                                                     BlurRadius="{StaticResource PinControl_ShadowBlurRadius}" 
                                                     ShadowDepth="{StaticResource PinControl_ShadowDepth}" 
                                                     Opacity="{StaticResource PinControl_EffectOpacity}" />
                                </Setter.Value>
                            </Setter>
                        </Trigger>

                        <!-- 连接状态 -->
                        <Trigger Property="IsConnecting" Value="True">
                            <Setter TargetName="PART_InputConnector" Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect Color="{StaticResource PinControl_ConnectingColor}" 
                                                     BlurRadius="{StaticResource PinControl_GlowBlurRadius}" 
                                                     ShadowDepth="{StaticResource PinControl_ShadowDepth}" 
                                                     Opacity="1.0" />
                                </Setter.Value>
                            </Setter>
                            <Setter TargetName="PART_OutputConnector" Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect Color="{StaticResource PinControl_ConnectingColor}" 
                                                     BlurRadius="{StaticResource PinControl_GlowBlurRadius}" 
                                                     ShadowDepth="{StaticResource PinControl_ShadowDepth}" 
                                                     Opacity="1.0" />
                                </Setter.Value>
                            </Setter>
                        </Trigger>

                        <!-- Flow 输入引脚：不显示未连接时的输入控件，只保留 Pin 与标签 -->
                        <DataTrigger Binding="{Binding PinData.IsFlowPin, RelativeSource={RelativeSource TemplatedParent}}" Value="True">
                            <Setter TargetName="PART_InputValue" Property="Visibility" Value="Collapsed" />
                        </DataTrigger>

                        <!-- 数据引脚：当已有连接时，隐藏编辑控件，仅显示标签 -->
                        <DataTrigger Binding="{Binding PinData.Connection, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource ObjectToVisibility_VisibleWhenNull}}" Value="Collapsed">
                            <Setter TargetName="PART_InputValue" Property="Visibility" Value="Collapsed" />
                        </DataTrigger>

                        <!-- 普通输入引脚且未连接：显示输入控件 -->
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding PinData.IsFlowPin, RelativeSource={RelativeSource TemplatedParent}}" Value="False" />
                                <Condition Binding="{Binding PinData.Connection, RelativeSource={RelativeSource TemplatedParent}}" Value="{x:Null}" />
                            </MultiDataTrigger.Conditions>
                            <Setter TargetName="PART_InputValue" Property="Visibility" Value="Visible" />
                        </MultiDataTrigger>

                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Default Style - Uses base style for backward compatibility -->
    <Style TargetType="{x:Type controls:PinControl}"
           BasedOn="{StaticResource {x:Static controls:PinControl.PinStyleKey}}" />

</ResourceDictionary>
