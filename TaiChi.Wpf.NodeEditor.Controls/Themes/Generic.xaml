<ResourceDictionary
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:TaiChi.Wpf.NodeEditor.Controls"
    xmlns:converters="clr-namespace:TaiChi.Wpf.NodeEditor.Controls.Converters"
    xmlns:core="clr-namespace:TaiChi.Wpf.NodeEditor.Core.Interfaces;assembly=TaiChi.Wpf.NodeEditor.Core"
    xmlns:dragDrop="clr-namespace:TaiChi.Wpf.NodeEditor.Controls.AttachedProperties"
    xmlns:helpers="clr-namespace:TaiChi.Wpf.NodeEditor.Controls.Helpers">

    <!--  å¼•å…¥æ¨¡æ¿èµ„æº  -->
    <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="/TaiChi.Wpf.NodeEditor.Controls;component/Themes/Converter.xaml" />
        <ResourceDictionary Source="/TaiChi.Wpf.NodeEditor.Controls;component/Themes/Colors.xaml" />
        <ResourceDictionary Source="/TaiChi.Wpf.NodeEditor.Controls;component/Themes/Dimensions.xaml" />
        <ResourceDictionary Source="/TaiChi.Wpf.NodeEditor.Controls;component/Themes/PinControlStyles.xaml" />
        <ResourceDictionary Source="/TaiChi.Wpf.NodeEditor.Controls;component/Themes/Templates/ToolBoxTemplates.xaml" />
    </ResourceDictionary.MergedDictionaries>

    <DataTemplate x:Key="DirectoryDataTemplate" DataType="{x:Type core:ICategoryTreeItemViewModel}">
        <StackPanel Orientation="Horizontal">
            <!--  åˆ†ç»„èŠ‚ç‚¹å›¾æ ‡  -->
            <TextBlock
                Margin="2,0"
                VerticalAlignment="Center"
                FontSize="12"
                FontWeight="Bold"
                Text="ðŸ“" />

            <!--  èŠ‚ç‚¹åç§°  -->
            <TextBlock
                Margin="2,0"
                FontSize="12"
                FontWeight="Bold"
                Text="{Binding Name}" />

            <!--  èŠ‚ç‚¹æ•°é‡  -->
            <TextBlock
                Margin="5,0,0,0"
                VerticalAlignment="Center"
                FontSize="10"
                Foreground="Gray"
                Text="{Binding NodeCount, StringFormat=' ({0})'}" />
        </StackPanel>
    </DataTemplate>

    <DataTemplate x:Key="ToolBoxNodeItemDataTemplate" DataType="{x:Type core:INodeTreeItemViewModel}">
        <controls:ToolboxItem
            dragDrop:DragDropExtensions.DragData="{Binding NodeMetadata}"
            dragDrop:DragDropExtensions.EnableDrag="{Binding RelativeSource={RelativeSource AncestorType=controls:ToolboxControl}, Path=AllowDrag}"
            AllowDoubleClickCreate="{Binding RelativeSource={RelativeSource AncestorType=controls:ToolboxControl}, Path=AllowDoubleClickCreate}"
            AllowDrag="{Binding RelativeSource={RelativeSource AncestorType=controls:ToolboxControl}, Path=AllowDrag}"
            IsSelected="{Binding IsSelected}"
            NodeMetadata="{Binding NodeMetadata}"
            ToolTip="{Binding ToolTipText}"
            Visibility="{Binding IsVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <!-- <controls:ToolboxItem.Style> -->
            <!--     <Style TargetType="controls:ToolboxItem"> -->
            <!--         <Style.Triggers> -->
            <!--  ~1~ é«˜äº®çŠ¶æ€ @1@  -->
            <!--             <Trigger Property="IsHighlighted" Value="True"> -->
            <!--                 <Setter Property="ItemBackground" Value="LightBlue" /> -->
            <!--                 <Setter Property="ItemBorderBrush" Value="Blue" /> -->
            <!--             </Trigger> -->
            <!--    -->
            <!--  ~1~ é€‰ä¸­çŠ¶æ€ @1@  -->
            <!--             <Trigger Property="IsSelected" Value="True"> -->
            <!--                 <Setter Property="ItemBackground" Value="LightSkyBlue" /> -->
            <!--                 <Setter Property="ItemBorderBrush" Value="DodgerBlue" /> -->
            <!--                 <Setter Property="ItemBorderThickness" Value="2" /> -->
            <!--             </Trigger> -->
            <!--         </Style.Triggers> -->
            <!--     </Style> -->
            <!-- </controls:ToolboxItem.Style> -->
        </controls:ToolboxItem>
    </DataTemplate>

    <controls:ToolBoxItemDataTemplateSelector
        x:Key="ToolBoxItemDataTemplateSelector"
        CategoryTemplate="{StaticResource DirectoryDataTemplate}"
        NodeTemplate="{StaticResource ToolBoxNodeItemDataTemplate}" />

    <HierarchicalDataTemplate
        x:Key="ToolBoxItemDataTemplate"
        DataType="{x:Type core:INodeTreeItemViewModel}"
        ItemsSource="{Binding Path=Children}">
        <ContentControl Content="{Binding}" ContentTemplateSelector="{StaticResource ToolBoxItemDataTemplateSelector}" />
    </HierarchicalDataTemplate>

    <!--  ConnectionControl æ ·å¼å’Œæ¨¡æ¿  -->
    <Style TargetType="{x:Type controls:ConnectionControl}">
        <Setter Property="Stroke" Value="#4A90E2" />
        <Setter Property="StrokeThickness" Value="2" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:ConnectionControl}">
                    <Canvas>
                        <!--  é«˜å…‰æ•£å°„æ•ˆæžœèƒŒæ™¯  -->
                        <Path
                            x:Name="PART_GlowPath"
                            Data="{TemplateBinding PathData}"
                            Fill="Transparent"
                            Opacity="0"
                            Stroke="{TemplateBinding Stroke}"
                            StrokeEndLineCap="Round"
                            StrokeStartLineCap="Round"
                            StrokeThickness="8">
                            <Path.Effect>
                                <BlurEffect Radius="4" />
                            </Path.Effect>
                        </Path>

                        <!--  è¿žæŽ¥çº¿è·¯å¾„  -->
                        <Path
                            x:Name="PART_ConnectionPath"
                            Cursor="Hand"
                            Data="{TemplateBinding PathData}"
                            Fill="Transparent"
                            Stroke="{TemplateBinding Stroke}"
                            StrokeEndLineCap="Round"
                            StrokeStartLineCap="Round"
                            StrokeThickness="{TemplateBinding StrokeThickness}" />

                    </Canvas>

                    <ControlTemplate.Triggers>
                        <!--  é¼ æ ‡æ‚¬åœçŠ¶æ€ - é«˜å…‰æ•£å°„æ•ˆæžœ  -->
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter TargetName="PART_GlowPath" Property="Opacity" Value="0.6" />
                            <Setter TargetName="PART_GlowPath" Property="Stroke" Value="#7BB3F0" />
                            <Setter TargetName="PART_ConnectionPath" Property="StrokeThickness" Value="3" />
                        </Trigger>

                        <!--  é€‰ä¸­çŠ¶æ€ - æ”¹å˜é¢œè‰²å’Œé«˜å…‰  -->
                        <Trigger Property="IsSelected" Value="True">
                            <Setter TargetName="PART_ConnectionPath" Property="Stroke" Value="#FF6B35" />
                            <Setter TargetName="PART_ConnectionPath" Property="StrokeThickness" Value="3" />
                            <Setter TargetName="PART_GlowPath" Property="Opacity" Value="0.8" />
                            <Setter TargetName="PART_GlowPath" Property="Stroke" Value="#FF8C5A" />
                        </Trigger>

                        <!--  é«˜äº®çŠ¶æ€  -->
                        <Trigger Property="IsHighlighted" Value="True">
                            <Setter TargetName="PART_ConnectionPath" Property="Stroke" Value="#F39C12" />
                            <Setter TargetName="PART_ConnectionPath" Property="StrokeThickness" Value="3" />
                            <Setter TargetName="PART_GlowPath" Property="Opacity" Value="0.7" />
                            <Setter TargetName="PART_GlowPath" Property="Stroke" Value="#F7DC6F" />
                        </Trigger>

                        <!--  æ¿€æ´»çŠ¶æ€ï¼ˆæ•°æ®æµåŠ¨ï¼‰  -->
                        <Trigger Property="IsActive" Value="True">
                            <Setter TargetName="PART_ConnectionPath" Property="Stroke" Value="#2ECC71" />
                            <Setter TargetName="PART_ConnectionPath" Property="StrokeThickness" Value="3" />
                            <Setter TargetName="PART_GlowPath" Property="Opacity" Value="0.9" />
                            <Setter TargetName="PART_GlowPath" Property="Stroke" Value="#58D68D" />
                            <Trigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard RepeatBehavior="Forever">
                                        <DoubleAnimation
                                            AutoReverse="True"
                                            Storyboard.TargetName="PART_GlowPath"
                                            Storyboard.TargetProperty="Opacity"
                                            From="0.5"
                                            To="1.0"
                                            Duration="0:0:1" />
                                    </Storyboard>
                                </BeginStoryboard>
                            </Trigger.EnterActions>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>

        <!--  é»˜è®¤å±žæ€§å€¼  -->
        <Setter Property="StrokeThickness" Value="2" />
        <Setter Property="Stroke" Value="Gray" />
        <Setter Property="Focusable" Value="True" />
    </Style>

    <!--  NodeControl æ ·å¼å’Œæ¨¡æ¿  -->
    <Style TargetType="{x:Type controls:NodeControl}">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:NodeControl}">
                    <Border
                        x:Name="PART_NodeBorder"
                        MinWidth="120"
                        Background="{TemplateBinding NodeBackground}"
                        BorderBrush="{TemplateBinding NodeBorderBrush}"
                        BorderThickness="{TemplateBinding NodeBorderThickness}"
                        CornerRadius="5"
                        Cursor="Hand">

                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <!--  èŠ‚ç‚¹å¤´éƒ¨  -->
                            <Border
                                Grid.Row="0"
                                Background="{TemplateBinding NodeBorderBrush}"
                                CornerRadius="5,5,0,0">
                                <Grid>
                                    <TextBlock
                                        x:Name="PART_NodeHeader"
                                        Margin="8,4"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        FontSize="12"
                                        FontWeight="Bold"
                                        Foreground="White"
                                        Text="{Binding NodeData.Name, RelativeSource={RelativeSource TemplatedParent}}"
                                        TextTrimming="CharacterEllipsis" />

                                    <!-- ä¸»èŠ‚ç‚¹è§’æ ‡ï¼šå³ä¸Šè§’â€œä¸»â€å­—æ ‡è¯† -->
                                    <Border HorizontalAlignment="Right" VerticalAlignment="Top"
                                            Margin="0,2,4,0"
                                            Background="#CCFFD54F"
                                            CornerRadius="3"
                                            Padding="4,0"
                                            Visibility="{Binding IsMain, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <TextBlock Text="ä¸»" FontSize="10" FontWeight="Bold" Foreground="#8A6D3B"/>
                                    </Border>
                                </Grid>
                            </Border>

                            <!--  èŠ‚ç‚¹å†…å®¹åŒºåŸŸ  -->
                            <Grid Grid.Row="1" Margin="5">
                                <Grid.RowDefinitions>
                                    <!--  æ ‡é¢˜ä¸‹æ–¹çš„ç¼–è¾‘å™¨åŒºåŸŸ  -->
                                    <RowDefinition Height="Auto" />
                                    <!--  æµç¨‹å¼•è„šåŒºåŸŸ  -->
                                    <RowDefinition Height="Auto" />
                                    <!--  æ•°æ®å¼•è„šåŒºåŸŸ  -->
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>

                                <!--  ç¼–è¾‘å™¨ï¼ˆå¦‚æœ‰å±žæ€§å¸¦ EditorForNode ç‰¹æ€§åˆ™æ˜¾ç¤ºï¼‰  -->
                                <ContentPresenter
                                    Grid.Row="0"
                                    Grid.ColumnSpan="3"
                                    Margin="2,4"
                                    HorizontalAlignment="Stretch"
                                    VerticalAlignment="Top"
                                    Content="{TemplateBinding Content}"
                                    ContentTemplate="{TemplateBinding NodeContentTemplate}" />

                                <!--  æµç¨‹å¼•è„šåŒºåŸŸ  -->
                                <Grid Grid.Row="1" Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!--  æµç¨‹å…¥å£å¼•è„š  -->
                                    <ItemsControl
                                        Grid.Column="0"
                                        Margin="0,2"
                                        VerticalAlignment="Top"
                                        ItemsSource="{Binding NodeData.InputPins, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource FlowPinFilterConverter}, ConverterParameter=true}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <controls:PinControl Margin="0,2" PinData="{Binding}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!--  æµç¨‹å‡ºå£å¼•è„š  -->
                                    <ItemsControl
                                        Grid.Column="2"
                                        Margin="0,2"
                                        VerticalAlignment="Top"
                                        ItemsSource="{Binding NodeData.OutputPins, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource FlowPinFilterConverter}, ConverterParameter=true}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <controls:PinControl Margin="0,2" PinData="{Binding}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Grid>

                                <!--  æ•°æ®å¼•è„šåŒºåŸŸ  -->
                                <Grid Grid.Row="2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!--  æ•°æ®è¾“å…¥å¼•è„š  -->
                                    <ItemsControl
                                        Grid.Column="0"
                                        Margin="0,2"
                                        VerticalAlignment="Top"
                                        ItemsSource="{Binding NodeData.InputPins, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource FlowPinFilterConverter}, ConverterParameter=false}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <controls:PinControl Margin="0,2" PinData="{Binding}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!--  ä¸­é—´ç©ºç™½å ä½ï¼ˆä¿æŒå¸ƒå±€å¯¹ç§°ï¼‰  -->
                                    <Grid Grid.Column="1" />

                                    <!--  æ•°æ®è¾“å‡ºå¼•è„š  -->
                                    <ItemsControl
                                        Grid.Column="2"
                                        Margin="0,2"
                                        VerticalAlignment="Top"
                                        ItemsSource="{Binding NodeData.OutputPins, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource FlowPinFilterConverter}, ConverterParameter=false}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <controls:PinControl Margin="0,2" PinData="{Binding}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Grid>
                            </Grid>
                        </Grid>
                    </Border>

                    <ControlTemplate.Triggers>
                        <!--  é€‰ä¸­çŠ¶æ€  -->
                        <Trigger Property="IsSelected" Value="True">
                            <Setter TargetName="PART_NodeBorder" Property="BorderBrush" Value="Orange" />
                            <!--  ä¸æ”¹å˜ BorderThicknessï¼Œé¿å…é€‰ä¸­/æœªé€‰ä¸­å¼•èµ·å¸ƒå±€åç§»å¯¼è‡´åæ ‡å˜åŒ–  -->
                            <Setter TargetName="PART_NodeBorder" Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect
                                        BlurRadius="8"
                                        ShadowDepth="0"
                                        Color="Orange" />
                                </Setter.Value>
                            </Setter>
                        </Trigger>

                        <!--  é«˜äº®çŠ¶æ€  -->
                        <Trigger Property="IsHighlighted" Value="True">
                            <Setter TargetName="PART_NodeBorder" Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect
                                        BlurRadius="10"
                                        ShadowDepth="0"
                                        Color="Blue" />
                                </Setter.Value>
                            </Setter>
                        </Trigger>

                        <!-- ä¸»èŠ‚ç‚¹çŠ¶æ€ï¼šé‡‘è‰²è¾¹æ¡†ä¸Žå…‰æ™• -->
                        <Trigger Property="IsMain" Value="True">
                            <Setter TargetName="PART_NodeBorder" Property="BorderBrush" Value="#DAA520" />
                            <Setter TargetName="PART_NodeBorder" Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect BlurRadius="10" ShadowDepth="0" Color="#DAA520"/>
                                </Setter.Value>
                            </Setter>
                        </Trigger>

                        <!--  æ‹–æ‹½çŠ¶æ€  -->
                        <Trigger Property="IsDragging" Value="True">
                            <Setter TargetName="PART_NodeBorder" Property="Opacity" Value="0.8" />
                            <Setter TargetName="PART_NodeBorder" Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect
                                        BlurRadius="15"
                                        ShadowDepth="5"
                                        Color="Gray" />
                                </Setter.Value>
                            </Setter>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>

        <!--  é»˜è®¤å±žæ€§å€¼  -->
        <Setter Property="NodeBackground" Value="White" />
        <Setter Property="NodeBorderBrush" Value="Gray" />
        <Setter Property="NodeBorderThickness" Value="1" />
        <Setter Property="Focusable" Value="True" />
        <!--  å°† NodeData ä½œä¸ºå†…å®¹ä¼ é€’ç»™æ¨¡æ¿  -->
        <Setter Property="Content" Value="{Binding NodeData, RelativeSource={RelativeSource Self}}" />
        <!--  é»˜è®¤ Node å†…å®¹æ¨¡æ¿ï¼šåŸºäºŽ EditorForNode ç‰¹æ€§æ¸²æŸ“ç¼–è¾‘å™¨  -->
        <Setter Property="NodeContentTemplate">
            <Setter.Value>
                <DataTemplate>
                    <ItemsControl>
                        <ItemsControl.ItemsSource>
                            <Binding
                                Converter="{StaticResource EditorForNodePropertiesConverter}"
                                Path="Content"
                                RelativeSource="{RelativeSource TemplatedParent}" />
                        </ItemsControl.ItemsSource>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="2,1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="8" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <!--  æ ‡ç­¾  -->
                                    <TextBlock
                                        Grid.Column="0"
                                        VerticalAlignment="Center"
                                        FontSize="11"
                                        Foreground="Black"
                                        Text="{Binding DisplayName}" />

                                    <Grid Grid.Column="2">
                                        <Grid.Resources>
                                            <!--  å°† Name æŒ‡å®šçš„å±žæ€§ç»‘å®šåˆ° NodeControl.NodeData ä¸Šçš„åŒåå±žæ€§  -->
                                            <helpers:PropertyBindingProxy
                                                x:Key="Proxy"
                                                PropertyName="{Binding Name}"
                                                Target="{Binding NodeData, RelativeSource={RelativeSource AncestorType=controls:NodeControl}}" />
                                        </Grid.Resources>

                                        <!--  å¸ƒå°”ç±»åž‹ç”¨ CheckBoxï¼Œå…¶å®ƒç±»åž‹ä½¿ç”¨ TextBox  -->
                                        <CheckBox
                                            VerticalAlignment="Center"
                                            Content=""
                                            IsChecked="{Binding Source={StaticResource Proxy}, Path=Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <CheckBox.Visibility>
                                                <Binding Converter="{StaticResource TypeIsBooleanConverter}" Path="PropertyType" />
                                            </CheckBox.Visibility>
                                        </CheckBox>

                                        <TextBox VerticalAlignment="Center" Text="{Binding Source={StaticResource Proxy}, Path=Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <TextBox.Visibility>
                                                <Binding Converter="{StaticResource TypeIsNotBooleanConverter}" Path="PropertyType" />
                                            </TextBox.Visibility>
                                        </TextBox>
                                    </Grid>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </DataTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!--  NodeCanvas æ ·å¼å’Œæ¨¡æ¿  -->
    <Style TargetType="{x:Type controls:NodeCanvas}">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:NodeCanvas}">
                    <Border Background="DarkGray" ClipToBounds="True">
                        <ScrollViewer
                            x:Name="PART_CanvasScrollViewer"
                            CanContentScroll="True"
                            HorizontalScrollBarVisibility="Auto"
                            PanningMode="Both"
                            VerticalScrollBarVisibility="Auto">

                            <Grid>
                                <!--  ç½‘æ ¼èƒŒæ™¯  -->
                                <controls:GridBackground
                                    x:Name="PART_GridBackground"
                                    Width="{TemplateBinding CanvasSize,
                                                            Converter={StaticResource SizeToWidthConverter}}"
                                    Height="{TemplateBinding CanvasSize,
                                                             Converter={StaticResource SizeToHeightConverter}}"
                                    GridSize="{TemplateBinding GridSize}"
                                    Visibility="{TemplateBinding ShowGrid,
                                                                 Converter={StaticResource BooleanToVisibilityConverter}}"
                                    ZoomLevel="{TemplateBinding ZoomLevel}" />

                                <!--  ä¸»ç”»å¸ƒ  -->
                                <Canvas
                                    x:Name="PART_MainCanvas"
                                    Width="{TemplateBinding CanvasSize,
                                                            Converter={StaticResource SizeToWidthConverter}}"
                                    Height="{TemplateBinding CanvasSize,
                                                             Converter={StaticResource SizeToHeightConverter}}"
                                    Background="Transparent"
                                    ClipToBounds="False">

                                    <Canvas.RenderTransform>
                                        <TransformGroup>
                                            <ScaleTransform x:Name="PART_ZoomTransform" ScaleX="{TemplateBinding ZoomLevel}" ScaleY="{TemplateBinding ZoomLevel}" />
                                            <TranslateTransform x:Name="PART_PanTransform" X="{TemplateBinding PanOffset, Converter={StaticResource PointToXConverter}}" Y="{TemplateBinding PanOffset, Converter={StaticResource PointToYConverter}}" />
                                        </TransformGroup>
                                    </Canvas.RenderTransform>

                                    <!--  åˆ†ç»„å±‚ï¼ˆä½äºŽè¿žæŽ¥çº¿ä¸ŽèŠ‚ç‚¹ä¹‹ä¸‹ï¼‰  -->
                                    <ItemsControl ItemsSource="{TemplateBinding GroupsSource}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="Canvas.Left" Value="{Binding Bounds.X}" />
                                                <Setter Property="Canvas.Top" Value="{Binding Bounds.Y}" />
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <controls:NodeGroupControl
                                                    Width="{Binding Bounds.Width}"
                                                    Height="{Binding Bounds.Height}"
                                                    GroupData="{Binding}"
                                                    IsSelected="{Binding IsSelected, Mode=TwoWay}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!--  è¿žæŽ¥çº¿å±‚  -->
                                    <ItemsControl ItemsSource="{TemplateBinding ConnectionsSource}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <controls:ConnectionControl
                                                    IsSelected="{Binding IsSelected}"
                                                    SourcePoint="{Binding SourcePointWpf}"
                                                    Stroke="{Binding StrokeBrush}"
                                                    StrokeThickness="{Binding StrokeThickness}"
                                                    TargetPoint="{Binding TargetPointWpf}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!--  å¾…å®šè¿žæŽ¥çº¿å±‚  -->
                                    <ContentPresenter Content="{Binding PendingConnection, RelativeSource={RelativeSource TemplatedParent}}">
                                        <ContentPresenter.ContentTemplate>
                                            <DataTemplate>
                                                <Path
                                                    Data="{Binding PathData}"
                                                    Opacity="0.7"
                                                    Stroke="{Binding StrokeBrush}"
                                                    StrokeEndLineCap="Round"
                                                    StrokeStartLineCap="Round"
                                                    StrokeThickness="{Binding StrokeThickness}">
                                                    <Path.Effect>
                                                        <DropShadowEffect
                                                            BlurRadius="6"
                                                            Opacity="0.6"
                                                            ShadowDepth="0"
                                                            Color="#7BB3F0" />
                                                    </Path.Effect>
                                                </Path>
                                            </DataTemplate>
                                        </ContentPresenter.ContentTemplate>
                                    </ContentPresenter>

                                    <!--  èŠ‚ç‚¹å±‚  -->
                                    <ItemsControl ItemsSource="{TemplateBinding NodesSource}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="Canvas.Left" Value="{Binding Position.X}" />
                                                <Setter Property="Canvas.Top" Value="{Binding Position.Y}" />
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <controls:NodeControl
                                                    IsSelected="{Binding IsSelected, Mode=TwoWay}"
                                                    IsMain="{Binding IsMainNode}"
                                                    NodeData="{Binding Model}"
                                                    NodeHeightProxy="{Binding Height, Mode=TwoWay}"
                                                    NodeWidthProxy="{Binding Width, Mode=TwoWay}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!--  é€‰æ‹©æ¡†  -->
                                    <controls:SelectionRectangle
                                        x:Name="PART_SelectionRectangle"
                                        SelectionBorderBrush="DarkOrange"
                                        SelectionBrush="Orange"
                                        SelectionOpacity="0.3" />
                                </Canvas>
                            </Grid>
                        </ScrollViewer>
                    </Border>
                </ControlTemplate>
            </Setter.Value>
        </Setter>

        <!--  é»˜è®¤å±žæ€§å€¼  -->
        <Setter Property="CanvasSize" Value="5000,5000" />
        <Setter Property="ZoomLevel" Value="1.0" />
        <Setter Property="ShowGrid" Value="True" />
        <Setter Property="GridSize" Value="20" />
        <Setter Property="Focusable" Value="True" />
        <Setter Property="ClipToBounds" Value="True" />
    </Style>

    <!--  å±•å¼€æŠ˜å æŒ‰é’®æ ·å¼  -->
    <Style x:Key="ExpandCollapseToggleStyle" TargetType="{x:Type ToggleButton}">
        <Setter Property="Focusable" Value="False" />
        <Setter Property="Width" Value="16" />
        <Setter Property="Height" Value="16" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type ToggleButton}">
                    <Border
                        Width="16"
                        Height="16"
                        Background="Transparent">
                        <Path
                            x:Name="ExpandPath"
                            Data="M 0 0 L 6 6 L 12 0"
                            Stroke="#666666"
                            StrokeThickness="1" />
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsChecked" Value="True">
                            <Setter TargetName="ExpandPath" Property="Data" Value="M 0 6 L 6 0 L 12 6" />
                        </Trigger>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter TargetName="ExpandPath" Property="Stroke" Value="#4A90E2" />
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!--  TreeViewItem æ ·å¼ - ä¸ŽçŽ°æœ‰ToolboxControlé£Žæ ¼ä¿æŒä¸€è‡´  -->
    <Style TargetType="{x:Type TreeViewItem}">
        <Setter Property="Background" Value="Transparent" />
        <Setter Property="BorderBrush" Value="Transparent" />
        <Setter Property="BorderThickness" Value="1" />
        <Setter Property="Padding" Value="2" />
        <Setter Property="Margin" Value="1" />
        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
        <Setter Property="VerticalContentAlignment" Value="Center" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type TreeViewItem}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <!--  å±•å¼€æŠ˜å æŒ‰é’®  -->
                        <ToggleButton
                            x:Name="Expander"
                            Grid.Row="0"
                            Grid.Column="0"
                            Margin="0,0,4,0"
                            ClickMode="Press"
                            IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"
                            Style="{StaticResource ExpandCollapseToggleStyle}" />

                        <!--  èŠ‚ç‚¹å†…å®¹è¾¹æ¡†  -->
                        <Border
                            x:Name="Bd"
                            Grid.Row="0"
                            Grid.Column="1"
                            Padding="{TemplateBinding Padding}"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            CornerRadius="3"
                            SnapsToDevicePixels="true">
                            <ContentPresenter
                                x:Name="PART_Header"
                                HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                ContentSource="Header"
                                SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" />
                        </Border>

                        <!--  å­é¡¹å®¹å™¨ - å‘ä¸‹æ‰©å±•  -->
                        <ItemsPresenter
                            x:Name="ItemsHost"
                            Grid.Row="1"
                            Grid.Column="1"
                            Margin="0,0,0,0" />
                    </Grid>

                    <ControlTemplate.Triggers>
                        <!--  é¼ æ ‡æ‚¬åœçŠ¶æ€  -->
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter TargetName="Bd" Property="Background" Value="#F0F8FF" />
                            <Setter TargetName="Bd" Property="BorderBrush" Value="#B0C4DE" />
                            <Setter TargetName="Bd" Property="BorderThickness" Value="1" />
                        </Trigger>

                        <!--  é€‰ä¸­çŠ¶æ€  -->
                        <Trigger Property="IsSelected" Value="True">
                            <Setter TargetName="Bd" Property="Background" Value="#E6F3FF" />
                            <Setter TargetName="Bd" Property="BorderBrush" Value="#4A90E2" />
                            <Setter TargetName="Bd" Property="BorderThickness" Value="2" />
                            <Setter TargetName="Bd" Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect
                                        BlurRadius="4"
                                        ShadowDepth="0"
                                        Color="#4A90E2" />
                                </Setter.Value>
                            </Setter>
                        </Trigger>


                        <!--  ç¦ç”¨çŠ¶æ€  -->
                        <Trigger Property="IsEnabled" Value="False">
                            <Setter TargetName="Bd" Property="Background" Value="#F5F5F5" />
                            <Setter TargetName="Bd" Property="BorderBrush" Value="Gray" />
                        </Trigger>

                        <!--  å±•å¼€/æŠ˜å çŠ¶æ€  -->
                        <Trigger Property="IsExpanded" Value="False">
                            <Setter TargetName="ItemsHost" Property="Visibility" Value="Collapsed" />
                        </Trigger>

                        <!--  æ— å­é¡¹æ—¶éšè—å±•å¼€æŒ‰é’®  -->
                        <Trigger Property="HasItems" Value="False">
                            <Setter TargetName="Expander" Property="Visibility" Value="Hidden" />
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!--  ToolboxControl æ ·å¼å’Œæ¨¡æ¿ - TreeViewç‰ˆæœ¬  -->
    <Style TargetType="{x:Type controls:ToolboxControl}">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:ToolboxControl}">
                    <Border
                        Background="White"
                        BorderBrush="Gray"
                        BorderThickness="1">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <!--  æœç´¢æ¡†  -->
                            <Border
                                Grid.Row="0"
                                Padding="5"
                                Background="LightGray"
                                Visibility="{TemplateBinding ShowSearch,
                                                             Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBox
                                    x:Name="PART_SearchTextBox"
                                    Padding="5,2"
                                    BorderBrush="Gray"
                                    BorderThickness="1"
                                    FontSize="12"
                                    Text="{TemplateBinding SearchText}">
                                    <TextBox.Style>
                                        <Style TargetType="TextBox">
                                            <Style.Triggers>
                                                <Trigger Property="Text" Value="">
                                                    <Setter Property="Background">
                                                        <Setter.Value>
                                                            <VisualBrush
                                                                AlignmentX="Left"
                                                                AlignmentY="Center"
                                                                Stretch="None">
                                                                <VisualBrush.Visual>
                                                                    <TextBlock
                                                                        FontStyle="Italic"
                                                                        Foreground="Gray"
                                                                        Text="æœç´¢èŠ‚ç‚¹..." />
                                                                </VisualBrush.Visual>
                                                            </VisualBrush>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBox.Style>
                                </TextBox>
                            </Border>

                            <!--  æ ‘å½¢èŠ‚ç‚¹åˆ—è¡¨  -->
                            <ScrollViewer
                                Grid.Row="1"
                                HorizontalScrollBarVisibility="Auto"
                                VerticalScrollBarVisibility="Auto">
                                <TreeView
                                    x:Name="PART_TreeView"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    ItemTemplate="{StaticResource ToolBoxItemDataTemplate}"
                                    ItemsSource="{TemplateBinding RootItems}"
                                    ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                                    VirtualizingStackPanel.IsVirtualizing="True"
                                    VirtualizingStackPanel.VirtualizationMode="Recycling" />
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </ControlTemplate>
            </Setter.Value>
        </Setter>

        <!--  é»˜è®¤å±žæ€§å€¼  -->
        <Setter Property="ShowSearch" Value="True" />
        <Setter Property="AllowDrag" Value="True" />
        <Setter Property="AllowDoubleClickCreate" Value="True" />
        <Setter Property="MinWidth" Value="250" />
    </Style>

    <!--  SelectionRectangle æ ·å¼å’Œæ¨¡æ¿  -->
    <Style TargetType="{x:Type controls:SelectionRectangle}">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:SelectionRectangle}">
                    <Rectangle
                        x:Name="PART_SelectionRectangle"
                        Fill="{TemplateBinding SelectionBrush}"
                        Opacity="{TemplateBinding SelectionOpacity}"
                        Stroke="{TemplateBinding SelectionBorderBrush}"
                        StrokeDashArray="3,2"
                        StrokeThickness="{TemplateBinding SelectionBorderThickness}" />
                </ControlTemplate>
            </Setter.Value>
        </Setter>

        <!--  é»˜è®¤å±žæ€§å€¼  -->
        <Setter Property="SelectionBrush" Value="LightBlue" />
        <Setter Property="SelectionBorderBrush" Value="Blue" />
        <Setter Property="SelectionBorderThickness" Value="1" />
        <Setter Property="SelectionOpacity" Value="0.3" />
        <Setter Property="IsHitTestVisible" Value="False" />
    </Style>

    <!--  GridBackground æ ·å¼å’Œæ¨¡æ¿  -->
    <Style TargetType="{x:Type controls:GridBackground}">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:GridBackground}">
                    <Border Background="{TemplateBinding Background}" />
                </ControlTemplate>
            </Setter.Value>
        </Setter>

        <!--  é»˜è®¤å±žæ€§å€¼  -->
        <Setter Property="GridSize" Value="20" />
        <Setter Property="GridBrush" Value="LightGray" />
        <Setter Property="GridThickness" Value="0.5" />
        <Setter Property="MajorGridInterval" Value="5" />
        <Setter Property="MajorGridBrush" Value="Gray" />
        <Setter Property="MajorGridThickness" Value="1" />
        <Setter Property="ShowMajorGrid" Value="True" />
        <Setter Property="IsHitTestVisible" Value="False" />
    </Style>

    <!--  ToolboxItem æ ·å¼å’Œæ¨¡æ¿  -->
    <Style TargetType="{x:Type controls:ToolboxItem}">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:ToolboxItem}">
                    <Border
                        x:Name="PART_ItemBorder"
                        Margin="2"
                        Padding="8,4"
                        Background="{TemplateBinding ItemBackground}"
                        BorderBrush="{TemplateBinding ItemBorderBrush}"
                        BorderThickness="{TemplateBinding ItemBorderThickness}"
                        CornerRadius="3"
                        Cursor="Hand">

                        <StackPanel>
                            <TextBlock
                                x:Name="PART_NameText"
                                FontSize="11"
                                FontWeight="Bold"
                                Foreground="Black"
                                Text="{Binding NodeMetadata.Name, RelativeSource={RelativeSource TemplatedParent}}"
                                TextTrimming="CharacterEllipsis" />

                            <TextBlock
                                x:Name="PART_DescriptionText"
                                Margin="0,2,0,0"
                                FontSize="9"
                                Foreground="Gray"
                                Text="{Binding NodeMetadata.Description, RelativeSource={RelativeSource TemplatedParent}}"
                                TextWrapping="Wrap"
                                Visibility="{Binding NodeMetadata.Description, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource StringToVisibilityConverter}}" />
                        </StackPanel>
                    </Border>

                    <ControlTemplate.Triggers>
                        <!--  é«˜äº®çŠ¶æ€  -->
                        <Trigger Property="IsHighlighted" Value="True">
                            <Setter TargetName="PART_ItemBorder" Property="Background" Value="LightBlue" />
                            <Setter TargetName="PART_ItemBorder" Property="BorderBrush" Value="Blue" />
                        </Trigger>

                        <!--  é€‰ä¸­çŠ¶æ€  -->
                        <!-- <Trigger Property="IsSelected" Value="True">
                            <Setter TargetName="PART_ItemBorder" Property="Background" Value="LightSkyBlue"/>
                            <Setter TargetName="PART_ItemBorder" Property="BorderBrush" Value="DodgerBlue"/>
                        </Trigger>-->
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>

        <!--  é»˜è®¤å±žæ€§å€¼  -->
        <Setter Property="ItemBackground" Value="White" />
        <Setter Property="ItemBorderBrush" Value="Transparent" />
        <Setter Property="ItemBorderThickness" Value="1" />
        <Setter Property="AllowDrag" Value="True" />
        <Setter Property="AllowDoubleClickCreate" Value="True" />
        <Setter Property="Focusable" Value="True" />
    </Style>

    <!--  ZoomController æ ·å¼å’Œæ¨¡æ¿  -->
    <Style TargetType="{x:Type controls:ZoomController}">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:ZoomController}">
                    <Border
                        Padding="5"
                        Background="White"
                        BorderBrush="Gray"
                        BorderThickness="1"
                        CornerRadius="3">
                        <StackPanel Orientation="Horizontal">
                            <!--  ç¼©å°æŒ‰é’®  -->
                            <Button
                                Width="24"
                                Height="24"
                                Margin="0,0,2,0"
                                Command="{TemplateBinding ZoomOutCommand}"
                                Content="âˆ’"
                                FontSize="14"
                                FontWeight="Bold" />

                            <!--  ç¼©æ”¾ç™¾åˆ†æ¯”  -->
                            <TextBlock
                                MinWidth="50"
                                Margin="2,0"
                                VerticalAlignment="Center"
                                FontSize="11"
                                Text="{Binding ZoomLevel, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource PercentageConverter}}"
                                TextAlignment="Center"
                                Visibility="{TemplateBinding ShowPercentage,
                                                             Converter={StaticResource BooleanToVisibilityConverter}}" />

                            <!--  æ”¾å¤§æŒ‰é’®  -->
                            <Button
                                Width="24"
                                Height="24"
                                Margin="2,0,0,0"
                                Command="{TemplateBinding ZoomInCommand}"
                                Content="+"
                                FontSize="14"
                                FontWeight="Bold" />

                            <!--  é¢„è®¾æŒ‰é’®  -->
                            <StackPanel
                                Margin="5,0,0,0"
                                Orientation="Horizontal"
                                Visibility="{TemplateBinding ShowPresetButtons,
                                                             Converter={StaticResource BooleanToVisibilityConverter}}">
                                <Button
                                    Margin="0,0,2,0"
                                    Padding="4,2"
                                    Command="{TemplateBinding FitToCanvasCommand}"
                                    Content="é€‚åº”"
                                    FontSize="10" />
                                <Button
                                    Padding="4,2"
                                    Command="{TemplateBinding ResetZoomCommand}"
                                    Content="100%"
                                    FontSize="10" />
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </ControlTemplate>
            </Setter.Value>
        </Setter>

        <!--  é»˜è®¤å±žæ€§å€¼  -->
        <Setter Property="ZoomLevel" Value="1.0" />
        <Setter Property="MinZoom" Value="0.1" />
        <Setter Property="MaxZoom" Value="5.0" />
        <Setter Property="ZoomStep" Value="0.1" />
        <Setter Property="ShowPercentage" Value="True" />
        <Setter Property="ShowPresetButtons" Value="True" />
    </Style>

    <!--  MiniMap æ ·å¼å’Œæ¨¡æ¿  -->
    <Style TargetType="{x:Type controls:MiniMap}">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:MiniMap}">
                    <Border
                        Background="{TemplateBinding MapBackground}"
                        BorderBrush="Gray"
                        BorderThickness="1"
                        CornerRadius="3">
                        <Grid>
                            <!--  å°åœ°å›¾ç”»å¸ƒ  -->
                            <Canvas x:Name="PART_MiniMapCanvas" ClipToBounds="True" />

                            <!--  è§†å£çŸ©å½¢  -->
                            <Rectangle
                                x:Name="PART_ViewportRectangle"
                                Fill="{TemplateBinding ViewportBrush}"
                                IsHitTestVisible="False"
                                Opacity="0.3"
                                Stroke="{TemplateBinding ViewportBorderBrush}"
                                StrokeThickness="1" />
                        </Grid>
                    </Border>
                </ControlTemplate>
            </Setter.Value>
        </Setter>

        <!--  é»˜è®¤å±žæ€§å€¼  -->
        <Setter Property="ScaleFactor" Value="0.1" />
        <Setter Property="ViewportBrush" Value="Blue" />
        <Setter Property="ViewportBorderBrush" Value="DarkBlue" />
        <Setter Property="MapBackground" Value="LightGray" />
        <Setter Property="NodeBrush" Value="Gray" />
        <Setter Property="Width" Value="200" />
        <Setter Property="Height" Value="150" />
    </Style>
</ResourceDictionary>
